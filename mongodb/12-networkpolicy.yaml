# =============================================================================
# 8. NETWORK POLICY  (deny-all + explicit whitelists)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-network-policy
  namespace: openedx
  labels:
    app.kubernetes.io/name: mongodb
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: mongodb
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Inter-replica traffic
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: mongodb
      ports:
        - port: 27017

    # ── App pods in the same openedx namespace ────────────────────────────────
    #    podSelector: {} allows ANY pod in namespace openedx to reach MongoDB.
    #    Tighten with specific labels once you know your app pod labels, e.g.:
    #      matchLabels:
    #        app.kubernetes.io/part-of: openedx
    - from:
        - podSelector: {}   # any pod in namespace openedx
      ports:
        - port: 27017

    # Prometheus scraping from monitoring namespace
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 9216

  egress:
    # Inter-replica traffic
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: mongodb
      ports:
        - port: 27017
    # DNS
    - to: []
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
